<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Todo App | Node.JS Express.JS SQLite</title>
        <link rel="stylesheet" href="/styles.css" />
        <link rel="stylesheet" href="/fanta.css" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
            integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>

    <body>
        <section id="auth">
            <div>
                <h2 className="sign-up-text">Login</h2>
                <p>Create an account!</p>
            </div>

            <p id="error" style="display: none"></p>
            <input id="emailInput" placeholder="Email" />
            <input id="passwordInput" placeholder="********" type="password" />
            <button id="authBtn" onclick="authenticate()">Submit</button>
            <hr />
            <div class="register-content">
                <p>Don&apos;t have an account?</p>
                <button onclick="toggleIsRegister()" id="registerBtn">
                    Sign up
                </button>
            </div>
        </section>
        <header style="display: none">
            <h1 class="text-gradient">You have 0 open tasks.</h1>
        </header>
        <nav style="display: none" class="tab-container">
            <button onclick="changeTab('All')" class="tab-button selected-tab">
                <h4>All <span>(0)</span></h4>
            </button>
            <button onclick="changeTab('Open')" class="tab-button">
                <h4>Open <span>(0)</span></h4>
            </button>
            <button onclick="changeTab('Complete')" class="tab-button">
                <h4>Complete <span>(0)</span></h4>
            </button>
            <hr />
        </nav>
        <main style="display: none"></main>
    </body>
    <script>
        let token = localStorage.getItem("token");

        let isLoading = false;
        let isAuthenticating = false;
        let isRegistration = false;
        let selectedTab = "All";
        let todos = [];

        const apiBase = "/";

        // Elements
        const nav = document.querySelector("nav");
        const header = document.querySelector("header");
        const main = document.querySelector("main");
        const navElements = document.querySelectorAll(".tab-button");
        const authContent = document.getElementById("auth");
        const textError = document.getElementById("error");
        const email = document.getElementById("emailInput");
        const password = document.getElementById("passwordInput");
        const registerBtn = document.getElementById("registerBtn");
        const authBtn = document.getElementById("authBtn");

        // ---------- PAGE RENDERING ----------
        async function showDashboard() {
            authContent.style.display = "none";
            nav.style.display = "block";
            header.style.display = "flex";
            main.style.display = "flex";
            renderTodos();
        }

        function updateHeaderText() {
            const openTodos = todos.filter((t) => !t.completed).length;
            header.querySelector("h1").innerText =
                openTodos === 1
                    ? `You have 1 open task.`
                    : `You have ${openTodos} open tasks.`;
        }

        function updateNavCount() {
            navElements.forEach((ele) => {
                const btnText = ele.innerText.split(" ")[0];
                const count = todos.filter((todo) => {
                    if (btnText === "All") return true;
                    return btnText === "Complete"
                        ? todo.completed
                        : !todo.completed;
                }).length;
                ele.querySelector("span").innerText = `(${count})`;
            });
        }

        function changeTab(tab) {
            selectedTab = tab;
            navElements.forEach((val) =>
                val.classList.toggle(
                    "selected-tab",
                    val.innerText.includes(tab),
                ),
            );
            renderTodos();
        }

        function renderTodos() {
            updateHeaderText();
            updateNavCount();

            let todoList = "";
            todos
                .filter((todo) => {
                    return selectedTab === "All"
                        ? true
                        : selectedTab === "Complete"
                          ? todo.completed
                          : !todo.completed;
                })
                .forEach((todo) => {
                    todoList += `
                <div class="card todo-item">
                    <p>${todo.task}</p>
                    <div class="todo-buttons">
                        <button onclick="updateTodo(${todo.id})" ${todo.completed ? "disabled" : ""}><h6>Done</h6></button>
                        <button onclick="deleteTodo(${todo.id})"><h6>Delete</h6></button>
                    </div>
                </div>`;
                });
            todoList += `
            <div class="input-container">
                <input id="todoInput" placeholder="Add task" />
                <button onclick="addTodo()"><i class="fa-solid fa-plus"></i></button>
            </div>`;
            main.innerHTML = todoList;
        }

        // ---------- AUTH ----------
        async function toggleIsRegister() {
            isRegistration = !isRegistration;
            registerBtn.innerText = isRegistration ? "Sign in" : "Sign up";
            document.querySelector("#auth > div h2").innerText = isRegistration
                ? "Sign Up"
                : "Login";
            document.querySelector(".register-content p").innerText =
                isRegistration
                    ? "Already have an account?"
                    : "Don't have an account?";
            document.querySelector(".register-content button").innerText =
                isRegistration ? "Sign in" : "Sign up";
        }

        async function authenticate() {
            const emailVal = email.value;
            const passVal = password.value;

            if (
                isLoading ||
                isAuthenticating ||
                !emailVal ||
                !passVal ||
                passVal.length < 6 ||
                !emailVal.includes("@")
            )
                return;

            textError.style.display = "none";
            isAuthenticating = true;
            authBtn.innerText = "Authenticating...";

            try {
                let url = isRegistration ? "auth/register" : "auth/login";
                const response = await fetch(apiBase + url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: emailVal,
                        password: passVal,
                    }),
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (!data.token) throw new Error("Failed to authenticate");

                token = data.token;
                localStorage.setItem("token", token);

                await fetchTodos();
                showDashboard();
            } catch (err) {
                console.error(err);
                textError.innerText = err.message;
                textError.style.display = "block";
            } finally {
                authBtn.innerText = "Submit";
                isAuthenticating = false;
            }
        }

        // ---------- TODOS ----------
        async function fetchTodos() {
            if (!token) return;
            isLoading = true;
            try {
                const response = await fetch(apiBase + "todos", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (response.status === 401) {
                    console.warn(
                        "Unauthorized! Token may be invalid or expired.",
                    );
                    return;
                }

                todos = await response.json();
                renderTodos();
            } catch (err) {
                console.error(err);
            } finally {
                isLoading = false;
            }
        }

        async function addTodo() {
            const todoInput = document.getElementById("todoInput");
            const task = todoInput.value.trim();
            if (!task) return;

            await fetch(apiBase + "todos", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ task }),
            });
            todoInput.value = "";
            fetchTodos();
        }

        async function updateTodo(id) {
            const todo = todos.find((t) => t.id === id);
            if (!todo) return;

            await fetch(`${apiBase}todos/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ task: todo.task, completed: 1 }),
            });
            fetchTodos();
        }

        async function deleteTodo(id) {
            await fetch(`${apiBase}todos/${id}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
            });
            fetchTodos();
        }

        // ---------- INIT ----------
        if (token) {
            fetchTodos().then(showDashboard);
        }
    </script>
</html>
